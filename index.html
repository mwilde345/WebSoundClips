<!DOCTYPE html>
<html>

<head>
  <title>
    Sound Clips
  </title>
  <meta charset="UTF-8">
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">

  <!-- jQuery library -->
  <script src="js/jquery-3.2.1.min.js"></script>

  <!-- Latest compiled JavaScript -->
  <script src="bootstrap/js/bootstrap.min.js"></script>
  <script src="node_modules/peaks.js/peaks.js"></script>
  <script src="node_modules/socket.io-client/dist/socket.io.js"></script>
</head>

<body>

  <!-- Youtube Player Iframe and Logging buttons -->
  <!-- ######################################### -->
  <div id="main" class="container">

    <div id="player"></div>
    </br>
    </br>
    <input value="" type="text" class="form-control" id="videoID" placeholder="Paste Youtube Link" />
    <button id="loadVideo" onclick="loadTheVideo()" class="btn btn-primary form-control">Load Video</button>
    </br>
    </br>
    <div id="buttons" class="btn-group" role="group">
      <a id="downloadLink" style="visibility: hidden;">download textFile</a>
      <button id="logBtn" onclick="logTime()" class="btn btn-info">Log Time</button>
      <button id="undoBtn" onclick="undoTime()" class="btn btn-warning">Undo</button>
      <button id="resetBtn" onclick="resetTime()" class="btn btn-danger">Reset</button>
      <button class="btn btn-primary" onclick="saveTimes()">Download Times</button>
      <button id="testClips" onclick="test()" class="btn">Test Clips</button>
    </div>
    <br><br>

    <!-- UPLOAD FILES -->
    <div class="form-group col-sm-3">
      <form id="videoTimes" action="upload" method="POST" enctype="multipart/form-data">
        <label for="fileSelect">Select text file</label>
        <input value="" class="form-control-file" id="fileSelect" type="file" name="textFile">
        <input class="form-control" type="submit" value="Upload Image">
      </form>
      <progress id="uploadProgress" value=0></progress>
    </div>
    
    </br><br>
    <!-- Table to store video times -->
    <!-- ########################## -->

    <div id="output" class="row">
      <div id="tableContainer">
        <table id="timeTable" class="table">
          <thead>
            <tr>
              <th>Start</th>
              <th>Stop</th>
            </tr>
          </thead>
          <tbody id="timeTableBody">
          </tbody>
        </table>
      </div>
      <button id="downloadBtn" onclick="download()" class="btn btn-success">Download MP3</button>
      <progress id="downloadProgress" max=100 value=0></progress>
      
    </div>

    <!-- Waveform container and controls-->
    <!-- ############################## -->
    <div id="audioStuff" class="jumbotron row">
      <div id="first-waveform-visualiser-container" class="row"></div>
      <audio controls=controls src="" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>

      <div id="controls">
        <div>
          <button class="btn btn-primary" data-action="zoom-in">Zoom in</button>
          <button class="btn btn-primary" data-action="zoom-out">Zoom out</button>
          <button class="btn btn-primary" data-action="add-segment">Add a Segment at current time</button>
          <button class="btn btn-primary" data-action="log-data">Log segments</button>
          <button class="btn btn-primary" data-action="save-segments">Save segments</button>
        </div>
        <div class="form-group col-sm-3">
          <form id="segmentTimes" action="upload" method="POST" enctype="multipart/form-data">
            <label for="fileSelect">Select text file</label>
            <input class="form-control-file" id="fileSelect" type="file" name="textFile">
            <input class="form-control" type="submit" value="Upload Image">
          </form>
          <progress id="uploadSegmentProgress" value=0></progress>
        </div>
        <div>
          <input type="text" id="seek-time" value="0.0">
          <button data-action="seek">Seek</button>
        </div>
      </div>

      <div class="log">
        <div id="segments" class="hide">
          <h2>Segments</h2>
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Label</th>
                <th>Start time</th>
                <th>End time</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
      <button id="trimBtn" onclick="trimClips()" class="btn btn-warning">Trim Clips</button>
      <progress value=0 id="trimProgress"></progress>
      <div id="trimOutput" class="container" style="display: none">
        <input value="" type='text' id='masterMovie' placeholder="Movie Title"/>
        <input value="" type='text' id='masterCreator' placeholder="Creator"/>
        <input value="" type='text' id='masterTags' placeholder="Tag1, tag2"/>
        <input value="" type='text' id='masterHints' placeholder="Hint1, hint2"/>
        <button class="btn btn-info" onclick="setAllDescriptors()">Apply To All</button>
        <table id="clipTable" class="table" onclick="tableClick(event)">
          <thead>
            <tr>
              <th>Clip</th>
              <th>Audio</th>
              <th>Loudness (db)</th>
              <th>Change</th>
              <th>First Five</th>
              <th>Essential Words</th>
              <th>Hints</th>
              <th>Tags</th>
              <th>Movie</th>
              <th>Creator</th>
            </tr>
          </thead>
          <tbody id="clipTableBody"></tbody>
        </table>
      </div>
      <div id="compressClipsDiv" style="display: none">
        <button id="checkFirstFive" onclick="checkFirstFive()" class="btn btn-info">Check First Five</button>
        <button id="compressClips" onclick="compress()" class="btn btn-warning">Compress</button>
        <button onclick="testDynamo()" class="btn btn-large btn-primary">Test Dynamo</button>
      </div>
      <br>
      <div id="s3UploadDiv" style="display: none">
        <input value="" type="text" class="form-control" id="s3Bucket" placeholder="bucket name"/>
        <button id="s3upload" onclick="s3upload()" class="btn btn-success">S3 Upload</button>
      </div>
    </div>
  </div>

  <!-- Other js functions -->
  <!-- ################## -->
  
  <script>
    var videoID = "V_laNt7Sh6g";
    var compressedClips = [];
    var io = io.connect("http://localhost:3000");
    var startPressed = false;
    var stopPressed = false;
    $("#audioStuff").hide();

    io.on('dynamo_test_done', function(data){
      console.log(data);
    });

    io.on('checked_first_five', function(data){
      console.log(data);
    });

    io.on("download_progress", function (data) {
      $("#downloadProgress").attr('value',data);
      //$("#trimOutput").append(data);
    });
    io.on("download_finished", function (data) {
      //update progres bar to 100 if it isn't already there
      videoID = data;
      $("#downloadBtn").prop("disabled", false);
      $("#audioStuff").show();
      $("audio").prop("src", 'videoSound/' + videoID + ".mp3");
      peaksFunction(peaks, videoID);
      addSegments(gatherTimes(), peaksInstance);
    });
    io.on('trim_done', function (data) {
      var clipID = data.clipID;
      var loudness = data.loudness;
      var rowString = "<tr><td>" + clipID +
        "</td><td><audio controls=controls type='audio/mpeg' src='./loudClips/" +
        clipID + loudness + ".mp3' id='" + clipID + "_audio'/></td>" +
        "<td id='" + clipID + "_loudness'>" + loudness + "</td>" +
        "<td><input type='text' value='" + loudness + "' id='" + clipID + "_change'></input>" +
        "<button id='changeButton' name='" + clipID + "' class='btn btn-info'>Change Loudness</button></td>"+
        "<td><input value='' type='text' id='firstFive' placeholder='First Five'/>"+
        "<button id='viewConflicts' class='btn btn-primary'><span class='glyphicon glyphicon-search'/></button>"+
        "<button id='approve' class='btn btn-success'><span class='glyphicon glyphicon-ok'/></button>"+
        "<button id='deny' class='btn btn-danger'><span class='glyphicon glyphicon-remove'/></button>"+
        "<td><input value='' type='text' id='essential' placeholder='Essential Words'/></td>"+
        "<td><input value='' type='text' id='hints' placeholder='Hints'/></td>"+
        "<td><input value='' type='text' id='tags' placeholder='Tags'/></td>"+
        "<td><input value='' type='text' id='movie' placeholder='Movie'/></td>"+
        "<td><input value='' type='text' id='creator' placeholder='Creator'/></td></tr>";
        //add a call to dynamo and a flag if first five are the same
      $("#clipTableBody").append(rowString);
      $("#trimProgress").val($("#clipTable audio").length);
      if($("#clipTable audio").length==peaksInstance.segments.getSegments().length){
        $("#trimOutput").show();
        $("#compressClipsDiv").show();
        $("#trimBtn").attr("disabled", false);
      }
    });

    io.on('loudness_done', function (data) {
      var newLoudness = data.loudness;
      var clipID = data.clipID;
      var rowNum = data.tableRow;
      //$("#clipTable tr:eq("+rowNum+") audio").attr("src",'');
      $("#clipTable tr:eq(" + rowNum + ") audio").attr("src", "./loudClips/" + clipID + newLoudness + ".mp3");
      //document.querySelector("#clipTable audio:nth-child("+rowNum+")").load()
      //$("#clipTable tr:eq("+rowNum+") audio").load();
      $("#clipTable tr:eq(" + rowNum + ") td:eq(2)").text(newLoudness);
    });

    io.on('compress_done', function (clipID) {
      console.log("Compressed " + clipID);
    });

    io.on('s3_upload_done', function (clipID) {
      console.log("Uploaded " + clipID);
    });
  </script>
  <script src="js/playerjs.js"></script>
  <script src="js/peaksHelper.js"></script>
  <script src="js/helpers.js"></script>
  <script src="js/fileUpload.js"></script>
</body>

</html>